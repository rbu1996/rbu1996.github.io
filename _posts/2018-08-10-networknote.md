---
layout: post
title: Network - Note
date: 2018-08-10 17:44:09.000000000 +09:00
published: true
---

## TCP/IP网络协议
目前TCP/IP协议是Internet中的“通用语言”，不同计算机群之间可以利用TCP/IP进行通信。

## 网络层次划分
为了使不同计算机厂家生产的计算机能够相互通信，以便在更大的范围内建立计算机网 络，国际标准化组织（ISO）在1978年提出了“开放系统互联参考模型”，即著名的OSI/RM模型（Open System Interconnection/Reference Model）。      
它将计算机网络体系结构的通信协议划分为七层，自下而上依次为：物理层（Physics Layer）、数据链路层（Data Link Layer）、网络层（Network Layer）、传输层（Transport Layer）、会话层（Session Layer）、表示层（Presentation Layer）、应用层（Application Layer）。其中第四层完成数据传送服务，上面三层面向用户。

## OSI七层网络模型
TCP/IP协议毫无疑问是互联网的基础协议，没有它就根本不可能上网，任何和互联网有关的操作都离不开TCP/IP协议。不管是OSI七层模型还是TCP/IP的四层、五层模型，每一层中都要自己的专属协议，完成自己相应的工作以及与上下层级之间进行沟通。由于OSI七层模型为网络的标准层次划分，所以我们以OSI七层模型为例从下向上进行一一介绍。

![7ceng-1.jpg]({{ "/assets/images/7ceng-1.jpg" | absolute_url }})     
![xieyi.jpg]({{ "/assets/images/xieyi.jpg" | absolute_url }})     

### 1. 物理层（Physical Layer）
1）主要定义物理设备标准，如网线的接口类型、光纤的接口类型、各种传输介质的传输速率等。      
    
2）主要作用是将数据最终编码为用 0、1标识的比特流，通过物理介质传输，这一层的数据叫做比特。      

### 2. 数据链路层（Data Link Layer）
1）数据链路层为网络层提供可靠的数据传输；

2）基本数据单位为帧（数据组合成数据块，在数据链路层中称这种数据块为帧（frame））；

3）主要的协议：以太网协议；

4）两个重要设备名称：交换机；         

5）该层的作用包括：主要将接收到的数据进行 MAC 地址（网卡地址）的封装与解封装。
      

++交换机++（switch）可以为接入交换机的任意两个网络节点提供独享的电信号通路。交换机工作在数据链路层。交换机拥有一条很高带宽的背部总线和内部交换矩阵。交换机的所有的端口都挂接在这条背部总线上，控制电路收到数据包以后，处理端口会查找内存中的地址对照表以确定目的MAC（网卡的硬件地址）的NIC（网卡）挂接在哪个端口上，通过内部交换矩阵迅速将数据包传送到目的端口，目的MAC若不存在，广播到所有的端口，接收端口回应后交换机会“学习”新的地址，并把它添加入内部MAC地址表中。

### 3. 网络层（Network Layer）
  
1）网络层中涉及TCP/IP的核心协议——IP协议。IP协议非常简单，仅仅提供不可靠、无连接的传送服务。      

2）网络层主要将接收到的数据进行 IP 地址的封装与解封装。   

3）通过TCP或者UDP协议绘制网络地图，数据包选取合适的路径进行传输  


3） 基本数据单位为IP数据包；

4） 重要的设备：路由器。   

5）IP协议的功能：

a. 寻址和路由；（根据对方的IP地址，寻找最佳路径传输信息）；

b. 传递服务：① 不可靠（IP协议只是尽自己最大努力去传输数据包），可靠性由上层协议提供（TCP协议）；② 无连接；（事先不建立会话）；

c. 数据包的分片和重组。
    
++路由器++（Router）路由器物理层从路由器的一个端口收到一个报文，上送到数据链路层。数据链路层去掉链路层封装，根据报文的协议域上送到网络层。网络层首先看报文是否是送给本机的，若是，去掉网络层封装，送给上层。若不是，则根据报文的目的地址查找路由表，若找到路由，将报文送给相应端口的数据链路层，数据链路层封装后，发送报文。若找不到路由，报文丢弃。
### 4. 传输层（Transport Layer）

1）传输层定义了一些数据传输的协议和端口号       

2）主要将接收的数据进行分段和传输，到达目的地址后在进行重组。       

3）常把这一层的数据叫做段。     

4）重要设备：网关。     

2）包含的主要协议：     

TCP协议（Transmission Control Protocol，传输控制协议）      

UDP协议（User Datagram Protocol，用户数据报协议）；   
　
### 5. 会话层

1）通过传输层建立数据传输的通路。      

2）主要在系统之间发起会话或者接收会话请求。

### 6. 表示层
1）主要进行对接收数据的解释、加密与解密、压缩与解压缩。        

2）确保一个系统的应用层发送的数据能被另一个系统的应用层识别。      


### 7. 应用层
1）主要是为一些终端应用程序提供服务。       

2）直接面对着用户的

3）包括一下协议：

①：超文本传输协议HTTP：这是一种最基本的客户机/服务器的访问协议；浏览器向服务器发送请求，而服务器回应相应的网页

②：文件传送协议FTP：提供交互式的访问，基于客户服务器模式，面向连接 使用TCP可靠的运输服务

   主要功能:减少/消除不同操作系统下文件的不兼容性 

③：远程登录协议TELNET：客户服务器模式，能适应许多计算机和操作系统的差异，网络虚拟终端NVT的意义

④：简单邮件传送协议SMTP：Client/Server模式，面向连接 

   基本功能：写信、传送、报告传送情况、显示信件、接收方处理信件 

⑤：DNS域名解析协议：DNS是一种用以将域名转换为IP地址的Internet服务

⑥：简单文件传送协议TFTP：客户服务器模式，使用UDP数据报，只支持文件传输，不支持交互，TFTP代码占内存小 

⑦：简单网络管理协议（SNMP）: SNMP模型的4个组件：被管理结点、管理站、管理信息、管理协议

   SNMP代理：运行SNMP管理进程的被管理结点

   对象：描述设备的变量

   管理信息库（MIB）：保存所有对象的数据结构

⑧DHCP动态主机配置协议: 发现协议中的引导文件名、空终止符、属名或者空,DHCP供应协议中的受限目录路径名 Options –可选参数字段，参考定义选择列表中的选择文件
## 交换机

## 路由器
### 静态路由
![static-router.jpg]({{ "/assets/images/static-router.jpg" | absolute_url }})     
在R1上添加

在R2上添加

## IP地址
![address.jpg]({{ "/assets/images/address.jpg" | absolute_url }})         
IP地址被用来给Internet上的电脑一个编号。日常见到的情况是每台联网的PC上都需要有IP地址，才能正常通信。我们可以把“个人电脑”比作“一台电话”，那么“IP地址”就相当于“电话号码”，而Internet中的路由器，就相当于电信局的“程控式交换机”。 


IP地址是一个32位的二进制数，通常被分割为4个“8位二进制数”（也就是4个字节）。IP地址通常用“点分十进制”表示成（a.b.c.d）的形式，其中，a,b,c,d都是0~255之间的十进制整数。例：点分十进IP地址（100.4.5.6），实际上是32位二进制数（01100100.00000100.00000101.00000110）。


概念	|特征	|网络范围	|默认掩码 
---|---|---|---|---|---
A类地址|	第1个8位中的第1位始终为0|	0-127.x.x.x	|255.0.0.0/8
B类地址|	第1个8位中的第1、2位始终为10|	128-191.x.x.x|	255.255.0.0/16
C类地址|	第1个8位中的第1、2、3位始终为110|	192-y.x.x.x	|255.255.255.0/24

IP地址=网络地址+主机地址

eg：如IP地址是202.112.14.137，掩码是255.255.255.224 ，
网络地址是202.112.14.128，子网号是128。
主机地址是202.112.14.137 

## 子网掩码
子网掩码(subnet mask)是一种用来指明一个IP地址的哪些位标识的是主机所在的子网，以及哪些位标识的是主机的位掩码。

子网掩码不能单独存在，它必须结合IP地址一起使用。子网掩码只有一个作用，就是将某个IP地址划分成网络地址和主机地址两部分。 
子网掩码是一个32位地址，用于屏蔽IP地址的一部分以区别网络标识和主机标识，并说明该IP地址是在局域网上，还是在远程网上。

子网掩码——屏蔽一个IP地址的网络部分的“全1”比特模式。对于A类地址来说，默认的子网掩码是255.0.0.0；对于B类地址来说默认的子网掩码是255.255.0.0；对于C类地址来说默认的子网掩码是255.255.255.0。

通过子网掩码，就可以判断两个IP在不在一个局域网内部。

子网掩码可以看出有多少位是网络号，有多少位是主机号

## 网关
网关(Gateway)。默认网关在网络层上以实现网络互连，是最复杂的网络互连设备，仅用于两个高层协议不同的网络互连。网关的结构也和路由器类似，不同的是互连层。网关既可以用于广域网互连，也可以用于局域网互连

网关实质上是一个网络通向其他网络的IP地址。

比如有网络A和网络B，网络A的IP地址范围为“192.168.1.1~192. 168.1.254”，子网掩码为255.255.255.0；网络B的IP地址范围为“192.168.2.1~192.168.2.254”，子网掩码为255.255.255.0。

在没有路由器的情况下，两个网络之间是不能进行TCP/IP通信的，即使是两个网络连接在同一台交换机（或集线器）上，TCP/IP协议也会根据子网掩码（255.255.255.0）判定两个网络中的主机处在不同的网络里。

而要实现这两个网络之间的通信，则必须通过网关。如果网络A中的主机发现数据包的目的主机不在本地网络中，就把数据包转发给它自己的网关，再由网关转发给网络B的网关，网络B的网关再转发给网络B的某个主机。

所以说，只有设置好网关的IP地址，TCP/IP协议才能实现不同网络之间的相互通信。那么这个IP地址是哪台机器的IP地址呢？网关的IP地址是具有路由功能的设备的IP地址，具有路由功能的设备有路由器、启用了路由协议的服务器（实质上相当于一台路由器）、代理服务器（也相当于一台路由器）。

## DNS 域名系统 (Domain Name System) 
DNS 是域名系统 (Domain Name System)的缩写，它是由解析器和域名服务器组成的。

域名服务器是指保存有该网络中所有主机的域名和对应IP地址，并具有将域名转换为IP地址功能的服务器。其中域名必须对应一个IP地址，而IP地址不一定有域名。域名系统采用类似目录树的等级结构。

域名服务器为客户机/服务器模式中的服务器方，它主要有两种形式：主服务器和转发服务器。将域名映射为IP地址的过程就称为“域名解析”。==在Internet上域名与IP地址之间是一对一（或者多对一）的，域名虽然便于人们记忆，但机器之间只能互相认识IP地址，它们之间的转换工作称为域名解析，域名解析需要由专门的域名解析服务器来完成，DNS就是进行域名解析的服务器。==

DNS 命名用于 Internet 等 TCP/IP 网络中，通过用户友好的名称查找计算机和服务。当用户在应用程序中输入 DNS 名称时，DNS 服务可以将此名称解析为与之相关的其他信息，如 IP 地址。

因为，你在上网时输入的网址，是通过域名解析系统解析找到了相对应的IP地址，这样才能上网。其实，域名的最终指向是IP。

万维网上作为域名和IP地址相互映射的一个分布式数据库，能够使用户更方便的访问互联网，而不用去记住能够被机器直接读取的IP数串。通过域名，最终得到该域名对应的IP地址的过程叫做域名解析（或主机名解析）。DNS协议运行在UDP协议之上，使用端口号53。

## 三次握手
![hand.jpg]({{ "/assets/images/hand.jpg" | absolute_url }})     
所谓三次握手(Three-way Handshake)，是指建立一个TCP连接时，需要客户端和服务器总共发送3个包。采用三次握手来建立一个连接。

三次握手的目的是连接服务器指定端口，建立TCP连接,并同步连接双方的序列号和确认号并交换 TCP 窗口大小信息.在socket编程中，客户端执行connect()时。将触发三次握手。


 1）第一次握手：建立连接时，客户端A发送SYN包(SYN=j)到服务器B，并进入SYN_SEND状态，等待服务器B确认。

 2）第二次握手：服务器B收到SYN包，必须确认客户A的SYN(ACK=j+1)，同时自己也发送一个SYN包(SYN=k)，即SYN+ACK包，此时服务器B进入SYN_RECV状态。

 3）第三次握手：客户端A收到服务器B的SYN＋ACK包，向服务器B发送确认包ACK(ACK=k+1)，此包发送完毕，客户端A和服务器B进入ESTABLISHED状态，完成三次握手。

完成三次握手，客户端与服务器开始传送数据。

++SYN++：同步序列编号（Synchronize Sequence Numbers）。是TCP/IP建立连接时使用的握手信号。

++ACK++：ACK (Acknowledgement）即是确认字符，在数据通信中，接收站发给发送站的一种传输类控制字符。表示发来的数据已确认接收无误。
在TCP/IP协议中，如果接收方成功的接收到数据，那么会回复一个ACK数据。通常ACK信号有自己固定的格式,长度大小,由接收方回复给发送方。

## VALN(Virtual LAN)
VLAN(Virtual LAN)虚拟局域网。LAN可以是由少数几台家用计算机构成的网络，也可以是数以百计的计算机构成的企业网络。VLAN所指的LAN特指使用路由器分割的网络——也就是广播域。

++广播域++：指的是广播帧(目标MAC地址全部为1)所能传递到的范围，亦即能够直接通信的范围。

### 设置VLAN的原因
使用VLAN功能后，它能够将网络分割成多个广播域。

![vlan-1.jpg]({{ "/assets/images/vlan-1.jpg" | absolute_url }})      
图中，是一个由5台二层交换机(交换机1～5)连接了大量客户机构成的网络。假设这时，计算机A需要与计算机B通信。在基于以太网的通信中，必须在数据帧中指定目标MAC地址才能正常通信，因此计算机A必须先广播“ARP请求(ARP Request)信息”，来尝试获取计算机B的MAC地址。

交换机1收到广播帧(ARP请求)后，会将它转发给除接收端口外的其他所有端口，也就是Flooding了。接着，交换机2收到广播帧后也会Flooding。交换机3、4、5也还会Flooding。最终ARP请求会被转发到同一网络中的所有客户机上。

这个ARP请求原本是为了获得计算机B的MAC地址而发出的。也就是说：只要计算机B能收到就万事大吉了。可是事实上，数据帧却传遍整个网络，导致所有的计算机都收到了它。如此一来，一方面广播信息消耗了网络整体的带宽，另一方面，收到广播信息的计算机还要消耗一部分CPU时间来对它进行处理。造成了网络带宽和CPU运算能力的大量无谓消耗。

### 实现VLAN
首先，在一台未设置任何VLAN的二层交换机上，任何广播帧都会被转发给除接收端口外的所有其他端口(Flooding)。例如，计算机A发送广播信息后，会被转发给端口2、3、4。

![vlan-2.jpg]({{ "/assets/images/vlan-2.jpg" | absolute_url }})         
首先，在一台未设置任何VLAN的二层交换机上，任何广播帧都会被转发给除接收端口外的所有其他端口(Flooding)。例如，计算机A发送广播信息后，会被转发给端口2、3、4。

![vlan-3.jpg]({{ "/assets/images/vlan-3.jpg" | absolute_url }})         
这时，如果在交换机上生成红、蓝两个VLAN;同时设置端口1、2属于红色VLAN、端口3、4属于蓝色VLAN。再从A发出广播帧的话，交换机就只会把它转发给同属于一个VLAN的其他端口——也就是同属于红色VLAN的端口2，不会再转发给属于蓝色VLAN的端口。
同样，C发送广播信息时，只会被转发给其他属于蓝色VLAN的端口，不会被转发给属于红色VLAN的端口。

## TRUNK
VLAN的作用是分割广播域，处于不同VLAN的端口在二层无法通信。两台交换机处于同一VLAN间的端口要想通信，需要用线连接起来。VLAN最多可以设定4000多个，两台交换机之间当然不可能连4000多根线。因此用一根骨干链路Trunk来连接两台交换机，作用就是让两台交换机上处于相同VLAN的端口能互相通信。Trunk上用特殊的封装方式来支持转发不同的VLAN的帧。

Trunk上允许转发不同VLAN的帧，所以需要打上特殊标记来区分帧到底属于哪个VLAN。比如收到VLAN2的帧后打上个VLAN2的标记，通过Trunk链路转发出去，对方交换机收到帧后，发现是VLAN2的帧，就将VLAN2的标记去掉后发送到VLAN2的端口。这样就实现了相同VLAN在不同交换机间的通信。

## 网络访问过程
上网需要的四个参数（本机），分别是：本机的ip地址、子网掩码、网关的ip地址、DNS的ip地址

我的服务器      
![internet-2.jpg]({{ "/assets/images/internet-2.jpg" | absolute_url }})

建立一个完整的socket连接需要的5个参数，分别是：本机ip，本机端口号，使用的网络协议，要访问的机器的ip，要访问机器的端口号

### 确定本机参数
```
ipconfig/all
```
### 确定访问内容
访问百度，输入www.baidu.com（http://www.baidu.com:8080/index.php）。

### 确定百度的ip地址
使用dns协议，向dns服务器发送数据包，dns服务器开启的是53端口（此时5要素都明确了），数据包结构如下：

head| head | head | data
---|---|---|---
以太网标头 | IP标头|UDP标头|DNS数据包

DNS服务器告诉我们百度的ip地址是：115.239.211.112
```
ping www.baidu.com
```
### 利用子网掩码判断我们访问的ip是否和我们是同一个网段
经过判断，我们要访问的ip跟我们不是同一个网段，因此，我们向百度发送数据包必须通过网关转发。也就是说接收方的mac地址是网关的mac地址（如果是同一个网段的话mac地址就是我们要访问的机器的mac地址）

### 应用层
浏览器访问使用的是http协议，构造的数据包如下：

head| head | head | data
---|---|---|---
以太网标头 | IP标头|TCP标头|HTTP数据包

### 传输层（TCP协议）

Tcp数据包需要设置端口，接收方的默认端口是80，本机的端口是一个随机生成的1024到65535之间的整数。假定为8888。

Tcp数据包的包头长度为20字节，加上http数据包，为4980字节。

### 网络层（IP协议）

然后tcp数据包再嵌入ip数据包，ip数据包需设置双方ip【已知】。IP数据包的头长度为20字节，总共是5000字节

### 网际接口层（以太网协议）

IP数据包嵌入以太网数据包，以太网数据包需设置双方mac地址【已知】，接收方即网关mac地址【通过arp协议得到】。

以太网数据包的数据部分最大为1500字节，因此ip数据包必须分成4个包，因为每个包都有自己的ip标头，因此四个包的ip数据包的长度分别是1500，1500，1500，560。

### 服务器响应
经过多个网关转发，具体的路由协议，可以参考计算机网络一书，百度服务器收到这四个以太网数据包，根据ip标头的序号，将四个包拼起来，取出完整的tcp数据包，读出”http请求”，做出“http响应”。再使用http协议发回来。完成通信。

## 路由器与交换机的区别与联系
### 路由器 
工作在第三层（网络层）       

路由器：寻址，转发（依靠 IP 地址） 

路由器内有一份路由表，里面有它的寻址信息（就像是一张地图），它收到网络层的数据报后，会根据路由表和选路算法将数据报转发到下一站（可能是路由器、交换机、目的主机）


### 交换机 
工作在第二层（链路层）       

交换机：过滤，转发（依靠 MAC 地址）

交换机内有一张MAC表，里面存放着和它相连的所有设备的MAC地址，它会根据收到的数据帧的首部信息内的目的MAC地址在自己的表中查找，如果有就转发，如果没有就放弃

### 网络访问过程
![tuopu.jpg]({{ "/assets/images/tuopu.jpg" | absolute_url }})
每一个路由器与其之下连接的设备，其实构成一个局域网      
交换机工作在路由器之下，就是也就是交换机工作在局域网内      
交换机用于局域网内网的数据转发      
路由器用于连接局域网和外网 

区域 | 7层模型：功能 | 物理设备 | 协议 | 数据|
---|---|---|---|---|---|---|---
主机|应用层：为终端应用程序提供服务，是访问网络的接口||DNS：将域名转化为IP地址；HTTP：是用于从www服务器传输超文本到本地浏览器的传送协议
 -|表示层：转换数据格式，确保一个系统应用层发送的数据能被另一个系统识别| |
-|会话层：通过传输层建立数据传输的通路，再系统见发起会话或接收回话请求| |
-|传输层：定义了数据传输的协议和端口号，提供应用进程之间的逻辑通讯||==TCP==：通过三次握手建立一个可靠的连接，不丢包| 数据段 Segment
网络|网络层：收到的数据进行IP地址的（解）封装，为数据在节点之间的传输创建逻辑链路|路由器：寻址，依靠IP地址转发，路由表|IP：寻址和路由，根据对方IP地址找到最佳路径传输信息，不可靠|数据包 Packet
-|链路层：在通信实体之间建立数据链路连接|交换机：过滤，依靠MAC地址转发，MAC表||帧 Frame
-|物理层：将数据最终编码为用 0、1标识的比特流，通过物理介质传输|网线，集线器||比特 Bit

        

TCP：建立一个TCP连接时，采用三次握手来建立一个连接
1）第一次握手：建立连接时，客户端A发送SYN包(SYN=j)到服务器B，并进入SYN_SEND状态，等待服务器B确认。       
2）第二次握手：服务器B收到SYN包，必须确认客户A的SYN(ACK=j+1)，同时自己也发送一个SYN包(SYN=k)，即SYN+ACK包，此时服务器B进入SYN_RECV状态。      
3）第三次握手：客户端A收到服务器B的SYN＋ACK包，向服务器B发送确认包ACK(ACK=k+1)，此包发送完毕，客户端A和服务器B进入ESTABLISHED状态，完成三次握手。

     
