---
layout: post
title: SQL Server AlwaysOn - Configure Domain Control (Domain Controller, Add the Nodes to Doamin)
date: 2018-07-23 15:45:34.000000000 +09:00
published: true
---

## Environment 

 -- | Domain Controller | Node 1 (Pri) | Node 2 | Node 3
---|---|---|---|---
Name | AD | SQL1 | SQL2 | SQL3 |
IP address | 172.16.16.100 | 172.16.16.101 | 172.16.16.102 | 172.16.16.103|
Subnet mask | 255.255.255.0 | 255.255.255.0 | 255.255.255.0 | 255.255.255.0|
Default gateway | 172.16.16.254| 172.16.16.254 |172.16.16.254 |172.16.16.254|
Preferred DNS | 127.0.0.1 | 172.16.16.100 |172.16.16.100| 172.16.16.100|
Alternate DNS | 114.114.114.114| 114.114.114.114| 114.114.114.114| 114.114.114.114
Failover Cluster | 172.16.16.200|
Alwayson IP | 172.16.16.110|
AG Listener | 172.16.16.120|

The failover cluster IP is used to connect failover cluster manager;        
The alwayson IP is used to connect alwayson group;      
The alwayson group listener IP is used as listener.

## Configure Domain Controller
### Domain Controller IP
Open Network and Sharing Center --> Ethernet Status --> Properties --> TCP/IPv4        
(Remember to disable IPv6)      
DNS server address points to local server       
![AD-1.jpg]({{ "/assets/images/AD-1.jpg" | absolute_url }})

### Advanced sharing setting 
Turn on sharing     
![AD-2.jpg]({{ "/assets/images/AD-2.jpg" | absolute_url }})

### Add roles and features
![AD-3.jpg]({{ "/assets/images/AD-3.jpg" | absolute_url }}) 
        
Add roles and features wizard       
![AD-4.jpg]({{ "/assets/images/AD-4.jpg" | absolute_url }})     
![AD-5.jpg]({{ "/assets/images/AD-5.jpg" | absolute_url }})     
![AD-6.jpg]({{ "/assets/images/AD-6.jpg" | absolute_url }})  
        
Server roles --> Active Directory Domain Service        
![AD-7.jpg]({{ "/assets/images/AD-7.jpg" | absolute_url }})     
        
Features --> NET Framework 3.5, Failover Clustering     
![AD-8.jpg]({{ "/assets/images/AD-8.jpg" | absolute_url }})     
![AD-9.jpg]({{ "/assets/images/AD-9.jpg" | absolute_url }})     
![AD-10.jpg]({{ "/assets/images/AD-10.jpg" | absolute_url }})       


### Promote the server to a domain controller
![AD-12.jpg]({{ "/assets/images/AD-12.jpg" | absolute_url }})     
        
Active Directory Domain Services Configuration Wizard --> Add a forest      
![AD-13.jpg]({{ "/assets/images/AD-13.jpg" | absolute_url }})       
        
Set password        
![AD-14.jpg]({{ "/assets/images/AD-14.jpg" | absolute_url }})               
![AD-14-1.jpg]({{ "/assets/images/AD-14-1.jpg" | absolute_url }})       
![AD-14-2.jpg]({{ "/assets/images/AD-14-2.jpg" | absolute_url }})       
![AD-14-3.jpg]({{ "/assets/images/AD-14-3.jpg" | absolute_url }})       
![AD-14-4.jpg]({{ "/assets/images/AD-14-4.jpg" | absolute_url }})       
![AD-15.jpg]({{ "/assets/images/AD-15.jpg" | absolute_url }})       

### Check the Computer Domain
Domain is changed into alwayson.sql      
![AD-16.jpg]({{ "/assets/images/AD-16.jpg" | absolute_url }})


### DNS Manager
Check the alwayson.sql, find the win-ad.        
![AD-22.jpg]({{ "/assets/images/AD-22.jpg" | absolute_url }})       
Done!

## Add Node Servers to the Domain

### Add features
Add roles and features          
The feature 'NET Framework 3.5 Features' is for SQL server installation.       
The feature 'Failover Cluster' is for joining the domain.
![failover-1.jpg]({{ "/assets/images/failover-1.jpg" | absolute_url }})         
![failover-2.jpg]({{ "/assets/images/failover-2.jpg" | absolute_url }})         
![failover-3.jpg]({{ "/assets/images/failover-3.jpg" | absolute_url }})         
![failover-4.jpg]({{ "/assets/images/failover-4.jpg" | absolute_url }})         
![failover-5.jpg]({{ "/assets/images/failover-5.jpg" | absolute_url }})         
![failover-6.jpg]({{ "/assets/images/failover-6.jpg" | absolute_url }})         
### Join in the Domain
Control panel --> System and Security --> System --> Change Settings --> Change      
![node-1.jpg]({{ "/assets/images/node-1.jpg" | absolute_url }})     
![node-2.jpg]({{ "/assets/images/node-2.jpg" | absolute_url }})         
   
        
Join in.        
![node-5.jpg]({{ "/assets/images/node-5.jpg" | absolute_url }})     
        
Notice: the user name is 'domain name\user name' as below.      
![node-6.jpg]({{ "/assets/images/node-6.jpg" | absolute_url }})     
        
Add all servers to the domain. Check the DNS Manager in control server.     
![node-7.jpg]({{ "/assets/images/node-7.jpg" | absolute_url }})     
Done!

## DNS Manager & AD Users and Computers
![dns.jpg]({{ "/assets/images/dns.jpg" | absolute_url }})       
![ad-user.jpg]({{ "/assets/images/ad-user.jpg" | absolute_url }})     
Done!


### An error is reported
![node-error.jpg]({{ "/assets/images/node-error.jpg" | absolute_url }})     
It says the domain could not be detected, so I checked the DNS address. I found I forgot to add the IP address of domain controller as DNS server address. Then, add it.      
![node-3.jpg]({{ "/assets/images/node-3.jpg" | absolute_url }})     
        
Try to join in alwayson.sql again, but see the same error message.      
Resolution: the controller IP is supposed to be the preferred DNS server!!!     
![node-4.jpg]({{ "/assets/images/node-4.jpg" | absolute_url }})  

## Failover Cluster
Login as domain administrator in a node server.(This server will be the main node in the cluster)        
I choose SQL1 here.
### Create a New Cluster
Open the Failover Cluster Manager       
![sql-1.jpg]({{ "/assets/images/sql-1.jpg" | absolute_url }}) 
    
Create a new cluster        
![sql-2.jpg]({{ "/assets/images/sql-2.jpg" | absolute_url }})       
![sql-3.jpg]({{ "/assets/images/sql-3.jpg" | absolute_url }})       
![sql-4.jpg]({{ "/assets/images/sql-4.jpg" | absolute_url }})       
![sql-5.jpg]({{ "/assets/images/sql-5.jpg" | absolute_url }})       
![sql-6.jpg]({{ "/assets/images/sql-6.jpg" | absolute_url }})       
![sql-7.jpg]({{ "/assets/images/sql-7.jpg" | absolute_url }})       
![sql-8.jpg]({{ "/assets/images/sql-8.jpg" | absolute_url }})       
![sql-9.jpg]({{ "/assets/images/sql-9.jpg" | absolute_url }})   
        
This is just the cluster's management name and management IP, independent of AlwaysOn        
![sql-10.jpg]({{ "/assets/images/sql-10.jpg" | absolute_url }})   
        
==Do not add any storage to the cluster==       
It is because we don't have any storage device now.     
![sql-11.jpg]({{ "/assets/images/sql-11.jpg" | absolute_url }})       
![sql-12.jpg]({{ "/assets/images/sql-12.jpg" | absolute_url }})      
